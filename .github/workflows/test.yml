name: pandagma test
on:
  workflow_dispatch:
    inputs:
      pandagma-conf:
        default: '["Arachis2_4_1_0", "Arachis2_5_2_0", "Cicer2_4_2_0", "Glycine_7_3_2", "Glycine5_18_31_6", "Medicago2_7_0_16", "Vigna3_7_1_4", "family3_4_3"]'
        description: Run pandagma once for each config/NAME.conf file in the list
        required: false

jobs:
  pandagma:
    strategy:
      fail-fast: false
      matrix:
        PANDAGMA_CONF: ${{ fromJSON(github.event.inputs.pandagma-conf) }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Fetch data
      run: |
        mkdir data
        PATH=$PWD/bin:$PATH make -C data -f "${PWD}/get_data/${{ matrix.PANDAGMA_CONF }}.mk"
    - name: Create conda environment
      # bioconda mmseqs doesn't have AVX2 enabled
      run: |
        sed -i'' -n '/mmseqs/!p' environment.yml
        conda env create && conda clean --all -y
        set -o pipefail -o errexit
        curl --fail -L https://github.com/soedinglab/MMseqs2/releases/download/15-6f452/mmseqs-linux-avx2.tar.gz | tar -xzf -

    - name: Run pandagma
      env:
        PANDAGMA_CONF: ${{ matrix.PANDAGMA_CONF }}
      run: |
        sudo mkdir -m 777 /mnt/work
        case ${PANDAGMA_CONF} in
          family*) WORKFLOW=fam ;;
          *) WORKFLOW=pan ;;
        esac
        mkdir -p ${PANDAGMA_OUT:=upload-artifact/pandagma-${PANDAGMA_CONF}}
        printf 'GITHUB_REPOSITORY: %s\n\n' "${GITHUB_REPOSITORY}" > ${PANDAGMA_OUT}/VERSION
        git show --quiet >> ${PANDAGMA_OUT}/VERSION
        cp config/${PANDAGMA_CONF}.conf ${PANDAGMA_OUT}
        env PATH=$PWD/bin:$PWD/mmseqs/bin:$PATH time -v conda run -n pandagma --no-capture-output pandagma ${WORKFLOW} -d data -c "config/${PANDAGMA_CONF}.conf" -w /mnt/work -o ${PANDAGMA_OUT} 2>&1 | tee ${PANDAGMA_OUT}/pandagma.log
    - name: Upload output artifacts
      uses: actions/upload-artifact@v4
      with:
        name: pandagma-${{ matrix.PANDAGMA_CONF }}
        # Need to create subdirectory to unzip as directory
        # https://github.com/actions/upload-artifact/issues/248
        path: upload-artifact
        if-no-files-found: error
        retention-days: 90
        compression-level: 9
